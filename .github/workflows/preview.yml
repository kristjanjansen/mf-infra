name: Preview Environment

on:
  workflow_call:
    inputs:
      service_name:
        required: true
        type: string
      port:
        required: true
        type: string
    secrets: {}

jobs:
  preview:
    runs-on: self-hosted
    permissions:
      pull-requests: write
      issues: write

    env:
      SERVICE_NAME: ${{ inputs.service_name }}
      PORT: ${{ inputs.port }}
      PR: ${{ github.event.number || 1 }}

    steps:
      - uses: actions/checkout@v4

      - name: Compute preview identifiers
        shell: bash
        run: |
          set -euo pipefail

          PR_NUMBER='${{ github.event.number || 1 }}'
          TITLE='${{ github.event.pull_request.title || '' }}'

          SUFFIX="pr-${PR_NUMBER}"

          shopt -s nocasematch
          if [[ "$TITLE" =~ ^RELEASE[[:space:]]+([^[:space:]]+).*$ ]]; then
            RAW_VERSION="${BASH_REMATCH[1]}"

            SAFE_VERSION="$(echo "$RAW_VERSION" | tr -c 'a-zA-Z0-9' '-' | tr -s '-' | sed 's/^-*//;s/-*$//')"
            if [ -z "$SAFE_VERSION" ]; then
              SAFE_VERSION="0-0-0"
            fi

            SUFFIX="rel-${SAFE_VERSION}"
          fi
          shopt -u nocasematch

          echo "NAMESPACE=${SERVICE_NAME}-${SUFFIX}" >> "$GITHUB_ENV"
          echo "IMAGE=${SERVICE_NAME}:${SUFFIX}" >> "$GITHUB_ENV"
          echo "HOST=${SERVICE_NAME}-${SUFFIX}.localtest.me" >> "$GITHUB_ENV"

      - name: Build Docker image
        run: |
          docker build \
            --build-arg SERVICE_NAME="$SERVICE_NAME" \
            -t "$IMAGE" .

      - name: Deploy preview via infra action
        uses: kristjanjansen/mf-infra/.github/actions/deploy-preview@main
        with:
          service_name: ${{ env.SERVICE_NAME }}
          namespace: ${{ env.NAMESPACE }}
          image: ${{ env.IMAGE }}
          host: ${{ env.HOST }}
          port: ${{ env.PORT }}

      - name: Comment PR
        uses: kristjanjansen/mf-infra/.github/actions/comment-preview@main
        with:
          message: |
            ðŸš€ Preview ready: http://${{ env.HOST }}

  cleanup:
    if: github.event.action == 'closed'
    runs-on: self-hosted

    env:
      SERVICE_NAME: ${{ inputs.service_name }}

    steps:
      - name: Compute preview identifiers
        shell: bash
        run: |
          set -euo pipefail

          PR_NUMBER='${{ github.event.number || 1 }}'
          TITLE='${{ github.event.pull_request.title || '' }}'

          SUFFIX="pr-${PR_NUMBER}"
          SHOULD_DELETE="true"

          shopt -s nocasematch
          if [[ "$TITLE" =~ ^RELEASE[[:space:]]+([^[:space:]]+).*$ ]]; then
            RAW_VERSION="${BASH_REMATCH[1]}"

            SAFE_VERSION="$(echo "$RAW_VERSION" | tr -c 'a-zA-Z0-9' '-' | tr -s '-' | sed 's/^-*//;s/-*$//')"
            if [ -z "$SAFE_VERSION" ]; then
              SAFE_VERSION="0-0-0"
            fi

            SUFFIX="rel-${SAFE_VERSION}"
            SHOULD_DELETE="false"
          fi
          shopt -u nocasematch

          echo "NAMESPACE=${SERVICE_NAME}-${SUFFIX}" >> "$GITHUB_ENV"
          echo "SHOULD_DELETE=${SHOULD_DELETE}" >> "$GITHUB_ENV"

      - uses: kristjanjansen/mf-infra/.github/actions/delete-preview@main
        if: env.SHOULD_DELETE == 'true'
        with:
          namespace: ${{ env.NAMESPACE }}
